let _ = require("lodash-node");

// var dt = require("date-and-time");
// var q = require('dj-utils').query.criteria;
// var uuid = require('uuid');


// let _util = {
//                     format:{
//                         date: function(value,format){
//                            format = format || "YYYY MM DD";
//                            return dt.format(value,format)
//                         }
//                     },
//                     parse:{
//                         number: function(value){return value/1},
//                         date: function(value,format){
//                             format = format || "YYYY MM DD";
//                             return dt.parse(value,format)
//                         }
//                     },
//                     comparator:q,
//                     uuid:uuid
//                 };

let $scope = {}

$scope.answers = [
  {
    "form": "5ac38199e119266023685f82",
    "user": {
      "isAdmin": true,
      "email": "boldak.andrey@gmail.com",
      "name": "Andrey Boldak",
      "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
      "createdAt": "2017-12-18T13:53:14.442Z",
      "updatedAt": "2018-04-03T13:09:14.883Z",
      "id": "5a37c84a4dd564c00875a351",
      "isLoggedIn": true,
      "isOwner": true,
      "isCollaborator": false
    },
    "data": {
      "w88wwbyvbv": {
        "valid": true,
        "question": "w88wwbyvbv",
        "type": "check",
        "value": [
          "7mdf0x6qq5",
          "piugqh3z4g9",
          "82pwwoviebq"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      }
    },
    "createdAt": "2018-04-03T18:43:46.679Z",
    "updatedAt": "2018-04-06T09:47:12.128Z",
    "id": "5ac3cb62e119266023685f83"
  },
  {
    "form": "5ac38199e119266023685f82",
    "user": {
      "email": "datajockey.forms@gmail.com",
      "name": "dj forms",
      "photo": "https://lh3.googleusercontent.com/-Gd4fo7tow2c/AAAAAAAAAAI/AAAAAAAAABQ/pf8xKMi4S3c/photo.jpg?sz=500",
      "createdAt": "2018-04-04T19:46:19.086Z",
      "updatedAt": "2018-04-04T19:46:19.086Z",
      "id": "5ac52b8b3792961814660867",
      "isLoggedIn": true,
      "isOwner": false,
      "isCollaborator": false
    },
    "data": {
      "w88wwbyvbv": {
        "valid": false,
        "question": "w88wwbyvbv",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"axas\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "ko7hjsvkvb": {
        "valid": true,
        "question": "ko7hjsvkvb",
        "type": "check",
        "value": [
          "gw9mwjadadp",
          "th5jgddyggh"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      }
    },
    "createdAt": "2018-04-04T19:47:10.736Z",
    "updatedAt": "2018-04-07T16:44:22.520Z",
    "id": "5ac52bbee119266023685f84"
  },
  {
    "form": "5ac38199e119266023685f82",
    "user": {
      "isAdmin": true,
      "email": "boldak.andrey@gmail.com",
      "name": "Andrey Boldak",
      "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
      "createdAt": "2017-12-18T13:53:14.442Z",
      "updatedAt": "2018-04-03T13:09:14.883Z",
      "id": "5a37c84a4dd564c00875a351",
      "isLoggedIn": true,
      "isOwner": true,
      "isCollaborator": false
    },
    "data": {
      "w88wwbyvbv": {
        "valid": true,
        "question": "w88wwbyvbv",
        "type": "check",
        "value": [
          "7mdf0x6qq5",
          "9jx631in6wp",
          "p9h1nzzxcob"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "hwlaehbdhme": {
        "valid": false,
        "question": "hwlaehbdhme",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"The layout-align directive takes two wor...\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "ue5rqs0mihr": {
        "valid": false,
        "question": "ue5rqs0mihr",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      }
    },
    "createdAt": "2018-04-07T08:45:59.160Z",
    "updatedAt": "2018-04-07T08:45:59.160Z",
    "id": "5ac88547e119266023685f85"
  },
  {
    "form": "5ac38199e119266023685f82",
    "user": {
      "isAdmin": true,
      "email": "boldak.andrey@gmail.com",
      "name": "Andrey Boldak",
      "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
      "createdAt": "2017-12-18T13:53:14.442Z",
      "updatedAt": "2018-04-03T13:09:14.883Z",
      "id": "5a37c84a4dd564c00875a351",
      "isLoggedIn": true,
      "isOwner": true,
      "isCollaborator": false
    },
    "data": {
      "w88wwbyvbv": {
        "valid": true,
        "question": "w88wwbyvbv",
        "type": "check",
        "value": [
          "bmeo33tu4iq",
          "p9h1nzzxcob",
          "piugqh3z4g9"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "hwlaehbdhme": {
        "valid": false,
        "question": "hwlaehbdhme",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"The layout-align directive takes two wor...\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "ue5rqs0mihr": {
        "valid": false,
        "question": "ue5rqs0mihr",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      }
    },
    "createdAt": "2018-04-07T08:46:24.309Z",
    "updatedAt": "2018-04-07T08:46:24.309Z",
    "id": "5ac88560e119266023685f86"
  },
  {
    "form": "5ac38199e119266023685f82",
    "user": {
      "isAdmin": true,
      "email": "boldak.andrey@gmail.com",
      "name": "Andrey Boldak",
      "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
      "createdAt": "2017-12-18T13:53:14.442Z",
      "updatedAt": "2018-04-07T11:14:16.517Z",
      "id": "5a37c84a4dd564c00875a351",
      "isLoggedIn": true,
      "isOwner": true,
      "isCollaborator": false
    },
    "data": {
      "w88wwbyvbv": {
        "valid": true,
        "question": "w88wwbyvbv",
        "type": "check",
        "value": [
          "v30b92vpjwj",
          "piugqh3z4g9"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "hwlaehbdhme": {
        "valid": false,
        "question": "hwlaehbdhme",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"The layout-align directive takes two wor...\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "ue5rqs0mihr": {
        "valid": false,
        "question": "ue5rqs0mihr",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      }
    },
    "createdAt": "2018-04-07T11:51:28.004Z",
    "updatedAt": "2018-04-07T11:51:28.004Z",
    "id": "5ac8b0c003df2a40177fd72b"
  },
  {
    "form": "5ac38199e119266023685f82",
    "user": {
      "isAdmin": true,
      "email": "boldak.andrey@gmail.com",
      "name": "Andrey Boldak",
      "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
      "createdAt": "2017-12-18T13:53:14.442Z",
      "updatedAt": "2018-04-07T11:14:16.517Z",
      "id": "5a37c84a4dd564c00875a351",
      "isLoggedIn": true,
      "isOwner": true,
      "isCollaborator": false
    },
    "data": {
      "w88wwbyvbv": {
        "valid": true,
        "question": "w88wwbyvbv",
        "type": "check",
        "value": [
          "vk6uqqdjmza",
          "mg1p5q989k"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "hwlaehbdhme": {
        "valid": false,
        "question": "hwlaehbdhme",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"The layout-align directive takes two wor...\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "ue5rqs0mihr": {
        "valid": false,
        "question": "ue5rqs0mihr",
        "type": "check",
        "validationResult": {
          "valid": false,
          "message": "You should to select min 1 item in \n                            \"\" \n                            question.",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      }
    },
    "createdAt": "2018-04-07T11:53:15.841Z",
    "updatedAt": "2018-04-07T11:53:15.841Z",
    "id": "5ac8b12b03df2a40177fd72c"
  },
  {
    "form": "5ac38199e119266023685f82",
    "user": {
      "isAdmin": true,
      "email": "boldak.andrey@gmail.com",
      "name": "Andrey Boldak",
      "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
      "createdAt": "2017-12-18T13:53:14.442Z",
      "updatedAt": "2018-04-07T11:14:16.517Z",
      "id": "5a37c84a4dd564c00875a351",
      "isLoggedIn": true,
      "isOwner": true,
      "isCollaborator": false
    },
    "data": {
      "w88wwbyvbv": {
        "valid": true,
        "question": "w88wwbyvbv",
        "type": "check",
        "value": [
          "by0gmv1uade",
          "63yrmytigsj",
          "mt43iruz95",
          "1j6sl28nvzr",
          "9er0hffb8db",
          "3ku8lp1w7sk"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      },
      "ko7hjsvkvb": {
        "valid": true,
        "question": "ko7hjsvkvb",
        "type": "check",
        "value": [
          "th5jgddyggh"
        ],
        "validationResult": {
          "valid": true,
          "message": "",
          "needSaveAnswer": true,
          "needSaveForm": true
        }
      }
    },
    "createdAt": "2018-04-07T11:53:52.516Z",
    "updatedAt": "2018-04-07T16:43:54.087Z",
    "id": "5ac8b15003df2a40177fd72d"
  }
]

$scope.form = [
  {
    "metadata": {
      "app_name": {
        "key": "app_name",
        "value": "!22",
        "required": true,
        "editable": false
      },
      "app_title": {
        "key": "app_title",
        "value": "Title",
        "required": true,
        "editable": false
      },
      "app_url": {
        "key": "app_url",
        "value": "http://localhost:8080/app/!22/",
        "required": true,
        "editable": false
      },
      "app_icon": {
        "key": "app_icon",
        "value": "/img/default/7.png",
        "required": true,
        "editable": false
      },
      "page_title": {
        "key": "page_title",
        "value": "Home",
        "required": true,
        "editable": false
      },
      "title": {
        "key": "title",
        "value": "Form title...",
        "required": true,
        "editable": true
      },
      "note": {
        "key": "note",
        "value": "Form note...",
        "required": true,
        "editable": true
      },
      "aaa": {
        "key": "aaa",
        "value": "ddsf f fd fd",
        "required": false,
        "editable": true
      }
    },
    "config": {
      "locale": "uk",
      "access": {
        "type": "users",
        "enabled": true,
        "notificationTemplate": "\n<h4>\n  Dear {{user.name || 'Respondent'}}!\n</p> \n<p>\n  We invite you to take part in the survey \n  <a href=\"{{metadata.app_url}}\">\n    {{metadata.app_title}}\n  </a>\n  \n</p>\n",
        "notificationSubject": "JD-FORMS",
        "users": [
          {
            "isAdmin": true,
            "email": "boldak.andrey@gmail.com",
            "name": "Andrey Boldak",
            "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
            "createdAt": "2017-12-18T13:53:14.442Z",
            "updatedAt": "2018-04-03T13:09:14.883Z",
            "id": "5a37c84a4dd564c00875a351",
            "selected": false,
            "notifiedAt": "2018-04-06T07:12:41.196Z"
          },
          {
            "isAdmin": false,
            "email": "data.jokey@gmail.com",
            "name": "Jam Doggy",
            "photo": "https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=500",
            "createdAt": "2017-12-18T14:04:14.737Z",
            "updatedAt": "2017-12-18T14:04:14.737Z",
            "id": "5a37cade4dd564c00875a353",
            "selected": false,
            "notifiedAt": "2018-04-06T07:12:41.196Z"
          },
          {
            "email": "wdc.kpi.team@gmail.com",
            "name": "wdc team",
            "photo": "https://lh4.googleusercontent.com/-DFGYLpvASZ0/AAAAAAAAAAI/AAAAAAAAAA8/Gec5AWGQ5Co/photo.jpg?sz=500",
            "createdAt": "2018-02-08T15:09:19.331Z",
            "updatedAt": "2018-02-08T15:09:19.331Z",
            "id": "5a7c681f96f58098283ae69e",
            "selected": false,
            "notifiedAt": "2018-04-06T07:12:41.196Z"
          },
          {
            "email": "vasya@vasya.com",
            "apikey": "rs1ucemgr5izws0drc0dvg",
            "selected": false,
            "find": false,
            "notifiedAt": "2018-04-06T07:12:41.196Z",
            "name": "Vasya"
          },
          {
            "email": "aaa@aaa.aaa",
            "apikey": "ahpvd38d3d6bqc02akxkbe",
            "selected": true,
            "find": false
          }
        ],
        "lastNotificatedAt": "2018-04-06T07:12:41.195Z"
      },
      "questions": {
        "w88wwbyvbv": {
          "type": {
            "value": "check",
            "title": "Many of many"
          },
          "widget": {
            "css": "fa fa-check-square",
            "view": "./widgets/v2.form.question/partitions/check.view.html",
            "options": "./widgets/v2.form.question/partitions/check.options.html"
          },
          "options": {
            "required": true,
            "addEnabled": true,
            "showUserInfo": false,
            "title": "axas",
            "note": "xasx",
            "showResponsesStat": true,
            "userCollaboration": true,
            "nominals": {
              "by0gmv1uade": {
                "title": "b1",
                "user": {
                  "isAdmin": true,
                  "email": "boldak.andrey@gmail.com",
                  "name": "Andrey Boldak",
                  "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
                  "createdAt": "2017-12-18T13:53:14.442Z",
                  "updatedAt": "2018-04-07T11:14:16.517Z",
                  "id": "5a37c84a4dd564c00875a351",
                  "isLoggedIn": true,
                  "isOwner": true,
                  "isCollaborator": false
                }
              },
              "3u7ftuzpmwx": {
                "title": "f1",
                "user": {
                  "email": "datajockey.forms@gmail.com",
                  "name": "dj forms",
                  "photo": "https://lh3.googleusercontent.com/-Gd4fo7tow2c/AAAAAAAAAAI/AAAAAAAAABQ/pf8xKMi4S3c/photo.jpg?sz=500",
                  "createdAt": "2018-04-04T19:46:19.086Z",
                  "updatedAt": "2018-04-04T19:46:19.086Z",
                  "id": "5ac52b8b3792961814660867",
                  "isLoggedIn": true,
                  "isOwner": false,
                  "isCollaborator": false
                }
              },
              "kmxase3gk2r": {
                "title": "f3",
                "user": {
                  "email": "datajockey.forms@gmail.com",
                  "name": "dj forms",
                  "photo": "https://lh3.googleusercontent.com/-Gd4fo7tow2c/AAAAAAAAAAI/AAAAAAAAABQ/pf8xKMi4S3c/photo.jpg?sz=500",
                  "createdAt": "2018-04-04T19:46:19.086Z",
                  "updatedAt": "2018-04-04T19:46:19.086Z",
                  "id": "5ac52b8b3792961814660867",
                  "isLoggedIn": true,
                  "isOwner": false,
                  "isCollaborator": false
                }
              }
            }
          },
          "id": "w88wwbyvbv"
        },
        "ko7hjsvkvb": {
          "type": {
            "value": "check",
            "title": "Many of many"
          },
          "widget": {
            "css": "fa-check-square",
            "view": "./widgets/v2.form.question/partitions/check.view.html",
            "options": "./widgets/v2.form.question/partitions/check.options.html"
          },
          "options": {
            "required": true,
            "addEnabled": true,
            "showUserInfo": true,
            "userCollaboration": true,
            "title": "",
            "note": "",
            "showResponsesStat": true,
            "nominals": {
              "gw9mwjadadp": {
                "title": "ff1",
                "user": {
                  "email": "datajockey.forms@gmail.com",
                  "name": "dj forms",
                  "photo": "https://lh3.googleusercontent.com/-Gd4fo7tow2c/AAAAAAAAAAI/AAAAAAAAABQ/pf8xKMi4S3c/photo.jpg?sz=500",
                  "createdAt": "2018-04-04T19:46:19.086Z",
                  "updatedAt": "2018-04-04T19:46:19.086Z",
                  "id": "5ac52b8b3792961814660867",
                  "isLoggedIn": true,
                  "isOwner": false,
                  "isCollaborator": false
                }
              },
              "th5jgddyggh": {
                "title": "bb1",
                "user": {
                  "isAdmin": true,
                  "email": "boldak.andrey@gmail.com",
                  "name": "Andrey Boldak",
                  "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
                  "createdAt": "2017-12-18T13:53:14.442Z",
                  "updatedAt": "2018-04-07T11:14:16.517Z",
                  "id": "5a37c84a4dd564c00875a351",
                  "isLoggedIn": true,
                  "isOwner": true,
                  "isCollaborator": false
                }
              }
            }
          },
          "id": "ko7hjsvkvb"
        }
      }
    },
    "owner": {
      "isAdmin": true,
      "email": "boldak.andrey@gmail.com",
      "name": "Andrey Boldak",
      "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
      "createdAt": "2017-12-18T13:53:14.442Z",
      "updatedAt": "2018-04-03T13:09:14.883Z",
      "id": "5a37c84a4dd564c00875a351",
      "isLoggedIn": true,
      "isOwner": true,
      "isCollaborator": false
    },
    "history": [
      {
        "state": "created",
        "message": "Create form via !22",
        "user": {
          "isAdmin": true,
          "email": "boldak.andrey@gmail.com",
          "name": "Andrey Boldak",
          "photo": "https://lh4.googleusercontent.com/-FXs5tjXLlzs/AAAAAAAAAAI/AAAAAAAAAMY/v9q_vfkyfGc/photo.jpg?sz=500",
          "createdAt": "2017-12-18T13:53:14.442Z",
          "updatedAt": "2018-04-03T13:09:14.883Z",
          "id": "5a37c84a4dd564c00875a351",
          "isLoggedIn": true,
          "isOwner": true,
          "isCollaborator": false
        },
        "date": "2018-04-03T13:28:57.431Z"
      }
    ],
    "createdAt": "2018-04-03T13:28:57.435Z",
    "updatedAt": "2018-04-07T16:43:54.026Z",
    "id": "5ac38199e119266023685f82"
  }
]
 
 let getValue = (object, prop) => {
    return (object) ? object[prop] : "$removed";
 };

 let questions = $scope.form[0].config.questions;
 let accessType = $scope.form[0].config.access.type;
 let invitedUsers = $scope.form[0].config.access.users || [];
 
 invitedUsers = invitedUsers.map(item => item.email); 

 let accessFilter = {
    any: item => true,
    users: item => item.user.id,
    invited: item => invitedUsers.indexOf(item.user.email)>=0
 }

 $scope.answers
  .filter(accessFilter[accessType])
  .forEach((a) => {
    a.data  = _.pairs(a.data)
                  .filter(item => questions[item[0]])
                  .filter(item => item[1].value)

    a.data.forEach( r => {
      
        if( ["radio","check","dropdown"].indexOf(r[1].type) >= 0 ){
          r[1].value = r[1].value.filter(item => questions[r[0]].options.nominals[item])
        }

        if( ["influences","pairs","radiopairs"].indexOf(r[1].type) >=0 ){
          r[1].value = r[1].value.filter(item => 
              questions[r[0]].options.entities[item.entity] && questions[r[0]].options.properties[item.property]
          )
        }

        if( ["scales"].indexOf(r[1].type) >= 0 ){
            r[1].value = r[1].value.filter(item => questions[r[0]].options.entities[item.entity])
        }  
    })

 })

        let answers = $scope.answers.map ((a) => {
          a.data = a.data.map(d => {
            d[1].title = questions[d[0]].options.title;
            
            d[1].id = d[0];
            
            if (!d[1].value) {
              return d[1]
            }
            
            if( ["influences"].indexOf(d[1].type) >=0 ){
              d[1].value = d[1].value.map(v => {
                return {
                  entity_id: v.entity,
                  entity_title: getValue(questions[d[0]].options.entities[v.entity],"title"),
                  property_id: v.property,
                  property_title: getValue(questions[d[0]].options.properties[v.property],"title"), 
                  value:v.value
                }
              }) 
            }

            if( ["pairs","radiopairs"].indexOf(d[1].type) >=0 ){
              d[1].value = d[1].value.map(v => {
                return {
                  entity_id: v.entity,
                  entity_title: getValue(questions[d[0]].options.entities[v.entity],"title"),
                  property_id: v.property,
                  property_title: getValue(questions[d[0]].options.properties[v.property],"title"), 
                  value:1
                }
              }) 
            }

            if( ["radio","check","dropdown"].indexOf(d[1].type) >= 0 ){
              d[1].value = d[1].value.map(v => {
                return {
                  entity_id: v,
                  entity_title: getValue(questions[d[0]].options.nominals[v], "title"),
                  property_id: "",
                  property_title:"",
                  value:1
                }
              }) 
            }
            
            if( ["scales"].indexOf(d[1].type) >= 0 ){
              d[1].value = d[1].value.map(v => {
                return {
                  entity_id: v.entity,
                  entity_title: getValue(questions[d[0]].options.entities[v.entity], "title"),
                  property_id: "",
                  property_title:"",
                  value:v.value
                }
              }) 
            }
            
            
            if( ["text","rate","range","datetime","scale"].indexOf(d[1].type) >= 0 ){
              d[1].value = d[1].value.map(v => {
                return {
                  entity_id: "",
                  entity_title: "",
                  property_id: "",
                  property_title:"",
                  value:(d[1].type=="datetime")? new Date(v) /* _util.format.date(new Date(v) , "DD/MM/YY HH:mm") */ : v
                }
              }) 
            }
            
            return d[1];
          })
          return a;
        });





        let responses = [];

        answers = answers.forEach( a => {
            a.data.forEach( d => {
              if(d.value){
                d.value.forEach( v => {
                    responses.push({
                      response_id:a.id,
                      updatedAt: a.updatedAt, //_util.format.date(a.updatedAt, "DD/MM/YY HH:mm"),
                      form:a.form,
                      respondent:(a.user.email)? a.user.email : "",
                      question_id: d.id,
                      question_title: d.title,
                      question_type: d.type,
                      valid:(d.valid)? 1 : 0,
                      entity_id: v.entity_id,
                      entity_title:v.entity_title,
                      property_id:v.property_id,
                      property_title:v.property_title,
                      value:v.value     
                    })
                  })    
              } 
            })
        });

        $scope.responses = responses;

console.log(JSON.stringify($scope.responses, null, "\t"))        