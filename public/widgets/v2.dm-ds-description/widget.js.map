{"version":3,"sources":["v2.dm-ds-description/widget.js"],"names":[],"mappings":"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","file":"v2.dm-ds-description/widget.js","sourcesContent":["import angular from 'angular';\r\nimport 'dictionary';\r\nimport 'ngReact';\r\nimport 'custom-react-directives';\r\n\r\n// console.log(\"REACT\",React);\r\nlet m = angular.module('app.widgets.v2.dm-ds-description', ['app.dictionary','app.dps','ngFileUpload','react','custom-react-directives'])\r\n  m.controller('DataManagerDSInfoController', function ($scope, $http, $dps, EventEmitter, \r\n    APIProvider, pageSubscriptions, $lookup, $translate,$modal, user, i18n, $scroll) {\r\n    \r\n\r\n    const eventEmitter = new EventEmitter($scope);\r\n    $scope.lookup = $lookup;\r\n    $scope.tagList = [];\r\n    $scope.key = undefined; \r\n\r\n\r\n\r\n    \r\n    var applyContext = function(template, context){\r\n      var getContextValue = function(){\r\n          var tags =arguments[1].split(\".\")\r\n          var value = context;\r\n          tags.forEach(function(tag){\r\n            tag = tag.trim();\r\n            value = value[tag] \r\n          })\r\n\r\n          return value\r\n      }\r\n      return template.replace(/(?:\\{\\{\\s*)([a-zA-Z0-9_\\.]*)(?:\\s*\\}\\})/gim, getContextValue)\r\n    }\r\n\r\n\r\n\r\n   \r\n    $scope.formatDate = i18n.formatDate;\r\n    $scope.dps = $dps;\r\n    \r\n    $scope.download = function(item){\r\n      item.download = true;\r\n     // $http.get(\"./api/dataset/download/\"+item.dataset.id)\r\n      $dps.get(\"/api/dataset/download/\"+item.dataset.id)\r\n        .success(function(){\r\n          item.download = false;\r\n        })\r\n    }\r\n\r\n    $scope.selectSource = function(key){\r\n      console.log(\"Select Source\")\r\n      eventEmitter.emit('setLookupKey', key,\"#Datasource\");\r\n      // let query = [{\"dataset.source\":[{equals:key}]}];\r\n      let query = \"$[?(@.dataset.source=='{{}}')]\".split(\"{{}}\").join(key);\r\n      eventEmitter.emit('searchQuery', query);\r\n    }\r\n\r\n    $scope.selectTopic = function(key){\r\n      console.log(\"Select Topic\")\r\n      eventEmitter.emit('setLookupKey', key, \"#Topic\");\r\n      // let query = [{\"dataset.topics\":[{includes:key}]}];\r\n      let query = \"$[?(@.dataset.topics.contains(function(d){return d.startWith('{{}}')}))]\".split(\"{{}}\").join(key);\r\n      eventEmitter.emit('searchQuery', query);\r\n    }\r\n\r\n    \r\n    $scope.lookup = $lookup;\r\n   \r\n\r\n    var prepareTopics = function(topics){\r\n      var simple_topics = [];\r\n      topics = (topics.forEach) ? topics : [topics];\r\n      topics.forEach(function(item){\r\n        item.split(\"/\").forEach(function(t){\r\n          if(simple_topics.filter(function(s){return s === t}).length === 0){simple_topics.push(t)}\r\n        });\r\n      })\r\n      return simple_topics;\r\n    }\r\n\r\n    $scope.prepareTopics = prepareTopics;\r\n\r\n    var downloadSamples = function(metadata){\r\n      if(metadata.dataset.preview){\r\n        for(var key in metadata.dataset.preview){\r\n          console.log(\"Inspect samples for \"+key+\": \"+applyContext(metadata.dataset.preview[key],metadata))\r\n          $dps.post(\"/api/data/script\",{\r\n            \"data\" : applyContext(metadata.dataset.preview[key],metadata),\r\n            \"key\"  :key,\r\n            \"locale\": i18n.locale()\r\n          })\r\n            .success(function(response){\r\n              console.log(response.key+\" RESPONSE \", response.data)\r\n              response.dataset = metadata.dataset.id\r\n              eventEmitter.emit('setData', response);\r\n            })\r\n            .error(function(response){\r\n              console.log(\"ERROR\", response)\r\n            })\r\n        }\r\n      }else{\r\n        eventEmitter.emit('setData', undefined);\r\n      }\r\n      \r\n\r\n    } \r\n\r\n    \r\n    \r\n    new APIProvider($scope)\r\n      .config(() => {\r\n        console.log(`widget ${$scope.widget.instanceName} is (re)configuring...`);\r\n        $scope.title = $scope.widget.title;\r\n        \r\n        $scope.s_listeners = ($scope.widget.s_listeners) ? $scope.widget.s_listeners.split(\",\") : [];\r\n        \r\n        pageSubscriptions().removeListeners({\r\n          emitter: $scope.widget.instanceName,\r\n          signal: \"searchQuery\"\r\n        })\r\n\r\n        pageSubscriptions().addListeners(\r\n          $scope.s_listeners.map((item) =>{\r\n            return {\r\n                emitter: $scope.widget.instanceName,\r\n                receiver: item.trim(),\r\n                signal: \"searchQuery\",\r\n                slot: \"searchQuery\"\r\n            }\r\n          })\r\n        );\r\n        \r\n\r\n        $scope.l_listeners = ($scope.widget.l_listeners) ? $scope.widget.l_listeners.split(\",\") : [];\r\n        \r\n        pageSubscriptions().removeListeners({\r\n          emitter: $scope.widget.instanceName,\r\n          signal: \"setLookupKey\"\r\n        })\r\n        \r\n        pageSubscriptions().addListeners(\r\n          $scope.l_listeners.map((item) =>{\r\n            return {\r\n                emitter: $scope.widget.instanceName,\r\n                receiver: item.trim(),\r\n                signal: \"setLookupKey\",\r\n                slot: \"setLookupKey\"\r\n            }\r\n          })\r\n        );\r\n\r\n        \r\n        $scope.d_listeners = ($scope.widget.d_listeners) ? $scope.widget.d_listeners.split(\",\") : [];\r\n        pageSubscriptions().removeListeners({\r\n          emitter: $scope.widget.instanceName,\r\n          signal: \"setData\"\r\n        })\r\n\r\n        pageSubscriptions().addListeners(\r\n          $scope.d_listeners.map((item) =>{\r\n            return {\r\n                emitter: $scope.widget.instanceName,\r\n                receiver: item.trim(),\r\n                signal: \"setData\",\r\n                slot: \"setData\"\r\n            }\r\n          })\r\n        );\r\n        \r\n        \r\n         eventEmitter.emit('setData', undefined);\r\n      })\r\n\r\n      .provide('setDataSet', (evt, value) => {\r\n        console.log(\"getDataSet\", value)\r\n        eventEmitter.emit('setData', undefined);\r\n        $scope.ds = value;\r\n        if($scope.ds){\r\n          eventEmitter.emit('setLookupKey', undefined);\r\n          eventEmitter.emit('searchQuery', undefined);\r\n          \r\n          \r\n          $scope.topics = prepareTopics($scope.ds.dataset.topics);\r\n          $scope.ds.dataset.$periodicity = $translate.instant('WIDGET.V2.DM-DS-DESCRIPTION.'+$scope.ds.dataset.periodicity); \r\n          $scroll($scope)\r\n          downloadSamples($scope.ds);\r\n        }  \r\n      })\r\n\r\n      .translate(() => { \r\n        if($scope.ds)\r\n        $scope.ds.dataset.$periodicity = $translate.instant('WIDGET.V2.DM-DS-DESCRIPTION.'+$scope.ds.dataset.periodicity); \r\n      })\r\n\r\n      .removal(() => {\r\n        console.log('Find Result widget is destroyed');\r\n      });\r\n  })\r\n\r\n\r\n\r\n"],"sourceRoot":"/source/"}