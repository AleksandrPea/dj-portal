{"version":3,"sources":["v2.script-suite/widget.js"],"names":[],"mappings":"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","file":"v2.script-suite/widget.js","sourcesContent":["import angular from 'angular';\r\n// import 'dictionary';\r\n// import 'ngReact';\r\n// import 'custom-react-directives';\r\n// import 'ng-prettyjson';\r\nimport 'ng-ace';\r\n\r\n\r\nlet m = angular.module('app.widgets.v2.script-suite', [\r\n    // 'app.dictionary',\r\n    'app.dps',\r\n    // 'ngFileUpload',\r\n    // 'react',\r\n    // 'custom-react-directives',\r\n    // 'ngPrettyJson',\r\n    \"ng.ace\"\r\n])\r\n\r\n\r\nm.controller('ScriptSuiteController', function(\r\n    $scope, \r\n    APIProvider, \r\n    dialog, \r\n    app,\r\n    i18n,\r\n    $dps,\r\n    EventEmitter,\r\n    $error, \r\n    log,\r\n    pageSubscriptions,\r\n    $q\r\n) {\r\n\r\n    const eventEmitter = new EventEmitter($scope);\r\n    \r\n    $scope.notSaved = false;\r\n\r\n    var __script;\r\n    \r\n    $scope.options = {\r\n        mode:'dps', \r\n        theme:'tomorrow',\r\n        onChange: function(e){\r\n         __script = e[1].getSession().getValue();\r\n         $scope.notSaved = true;\r\n         $scope.collapsed = true;\r\n         $scope.processed = false;\r\n         $scope.successed = false;\r\n         $scope.rejected = false;\r\n         \r\n         app.markModified()\r\n        }\r\n    }\r\n\r\n    $scope.getEditorScript = function(){\r\n        return __script;\r\n    }\r\n\r\n    $scope.keys = Object.keys;\r\n    \r\n    $scope.classed = function(index){\r\n        if(!$scope.selected) return \"row\";\r\n        return ($scope.keys($scope.widget.script)[index] == $scope.selected) ? \"row selected\": \"row\"\r\n    }\r\n    \r\n    $scope.saveScript = () => {\r\n        $scope.collapsed = true;\r\n        $scope.widget.script[$scope.selected] = $scope.getEditorScript(); \r\n        $scope.notSaved = false;\r\n        // $scope.processed = false;\r\n        $scope.successed = false;\r\n        $scope.rejected = false;\r\n        app.markModified();\r\n    }\r\n\r\n    $scope.doDeleteScript = () => {\r\n        $scope.collapsed = true;\r\n        // $scope.processed = false;\r\n        $scope.successed = false;\r\n        $scope.rejected = false;\r\n       \r\n        let index = $scope.keys($scope.widget.script).indexOf($scope.selected);\r\n        $scope.select();\r\n        let newSuite = {};\r\n        let keys = $scope.keys($scope.widget.script);\r\n        for(let i=0; i < keys.length; i++){\r\n            if(keys[i] != keys[index]){\r\n                newSuite[keys[i]] = $scope.widget.script[keys[i]]\r\n            }\r\n        }\r\n       \r\n        $scope.$evalAsync(function(){\r\n            $scope.widget.script = newSuite; \r\n            index = (index > ($scope.keys($scope.widget.script).length-1))?$scope.keys($scope.widget.script).length-1 : index;\r\n            $scope.select($scope.keys($scope.widget.script)[index])\r\n        })\r\n\r\n        app.markModified()\r\n    }\r\n    \r\n    $scope.deleteScript = () => {\r\n        $scope.collapsed = true;\r\n        // $scope.processed = false;\r\n        $scope.successed = false;\r\n        $scope.rejected = false;\r\n       \r\n        dialog({\r\n            title:'Delete script \"'+$scope.selected+'\"?',\r\n            form:{}\r\n        })\r\n        .then($scope.doDeleteScript)\r\n    }\r\n    $scope.doAddScript = (name, script) => {\r\n        $scope.collapsed = true;\r\n        $scope.processed = false;\r\n        $scope.successed = false;\r\n        $scope.rejected = false;\r\n       \r\n        $scope.widget.script[name] = (script)? script : ('// Write '+name+' script here')\r\n        $scope.select(name);\r\n        app.markModified();\r\n    }\r\n\r\n    $scope.addScript = () => {\r\n        dialog({\r\n            title:'Add script',\r\n            fields:{\r\n                name:{\r\n                    title: 'Script name',\r\n                    type:'text',\r\n                    validate: function (form){return !$scope.widget.script[form.fields.name.value]}\r\n                }\r\n            }\r\n        })\r\n        .then((form) =>{\r\n            $scope.doAddScript(form.fields.name.value)\r\n        })\r\n    }\r\n\r\n    $scope.renameScript = () => {\r\n        let temp = {\r\n            script: $scope.widget.script[$scope.selected],\r\n            name: $scope.selected\r\n        }\r\n\r\n        $scope.doDeleteScript();\r\n\r\n        dialog({\r\n            title:'Rename script',\r\n            fields:{\r\n                name:{\r\n                    title: 'Script name',\r\n                    type:'text',\r\n                    value:temp.name,\r\n                    validate: function (form){return !$scope.widget.script[form.fields.name.value]}\r\n                }\r\n            }\r\n        })\r\n        .then((form) =>{\r\n            $scope.doAddScript(form.fields.name.value, temp.script)\r\n        })\r\n        .catch(() =>{\r\n            $scope.doAddScript(temp.name, temp.script)\r\n        })\r\n    }\r\n\r\n    $scope.select = (name) => {\r\n        $scope.collapsed = true;\r\n        // $scope.processed = false;\r\n        $scope.successed = false;\r\n        $scope.rejected = false;\r\n       \r\n            \r\n        if($scope.selected) {\r\n            $scope.saveScript()\r\n        } else {\r\n            $scope.collapsed = true;\r\n        }    \r\n\r\n        if(!name){\r\n            $scope.selected = undefined;\r\n            $scope.notSaved = false;\r\n            return\r\n        }\r\n\r\n        $scope.script =  angular.copy($scope.widget.script[name]);\r\n        $scope.selected = name;\r\n        $scope.notSaved = false;\r\n    }\r\n\r\n    $scope.cancelProcess = () => {\r\n        if($scope.canceler) $scope.canceler.resolve();\r\n        $scope.canceled = true;\r\n    }\r\n\r\n    $scope.runScript = function() {\r\n        $scope.canceled = false;\r\n        if($scope.canceler) $scope.canceler.resolve();\r\n        $scope.canceler = $q.defer();\r\n        \r\n        $scope.response = undefined;\r\n        eventEmitter.emit('setData', undefined);\r\n        $scope.saveScript(); \r\n        \r\n        $scope.processed = true;\r\n       \r\n        \r\n        $dps.post(\"/api/script\", {\r\n                \"script\": $scope.widget.script[$scope.selected],\r\n                \"locale\": i18n.locale()\r\n            },\r\n            {timeout:$scope.canceler.promise})\r\n            .then(function(response) {\r\n                $scope.processed = false;\r\n                response.data.key = response.data.type;\r\n                if (response.data.key == 'error') {\r\n                    $error(response.data.data)\r\n                    $scope.response = {\r\n                        key: \"error\",\r\n                        data: response.data.data\r\n                    }\r\n                    $scope.rejected = true;\r\n                    eventEmitter.emit('setData', $scope.response);\r\n                } else {\r\n                    $scope.successed = true;\r\n                    if (response.data.key == \"url\") {\r\n                        $scope.response = {\r\n                            data: {\r\n                                success: $dps.getUrl() + response.data.data.url\r\n                            },\r\n                            key: \"json\"\r\n                        }\r\n                        window.open($dps.getUrl() + response.data.data.url, '_blank')\r\n                    } else {\r\n                        if(response.data.key == \"log\"){\r\n                            log({ title: \"\", messages: response.data.data});\r\n                            $scope.response = response.data \r\n                        }else{\r\n                            $scope.response = response.data    \r\n                        }\r\n                    }\r\n                    eventEmitter.emit('setData', $scope.response);\r\n                }\r\n            })\r\n    }\r\n\r\n    \r\n    new APIProvider($scope)\r\n        .config(() => {\r\n            $scope.widget.script = $scope.widget.script || {}\r\n            $scope.collapsed = ($scope.keys($scope.widget.script).length > 0)\r\n            \r\n            if($scope.keys($scope.widget.script).length > 0 && $scope.globalConfig.designMode){\r\n                $scope.select($scope.keys($scope.widget.script)[0])\r\n            }\r\n\r\n            $scope.d_listeners = ($scope.widget.d_listeners) ? $scope.widget.d_listeners.split(\",\") : [];\r\n            pageSubscriptions().removeListeners({\r\n                emitter: $scope.widget.instanceName,\r\n                signal: \"setData\"\r\n            })\r\n\r\n            $scope.response = {\r\n                message: \"Write script and execute it\"\r\n            };\r\n\r\n            pageSubscriptions().addListeners(\r\n                $scope.d_listeners.map((item) => {\r\n                    return {\r\n                        emitter: $scope.widget.instanceName,\r\n                        receiver: item.trim(),\r\n                        signal: \"setData\",\r\n                        slot: \"setData\"\r\n                    }\r\n                })\r\n            );\r\n\r\n            eventEmitter.emit('setData', undefined);\r\n        })\r\n        \r\n        .openCustomSettings(function() {\r\n            return dialog({\r\n                    title: \"DJ dps Suite settings\",\r\n                    fields: {\r\n                        d_listeners: {\r\n                            title: \"Listeners\",\r\n                            type: \"text\",\r\n                            value: $scope.widget.d_listeners,\r\n                            required: false\r\n                        }\r\n                    }\r\n                })\r\n                .then(function(form) {\r\n                    $scope.widget.d_listeners = form.fields.d_listeners.value;\r\n                    })\r\n        })\r\n\r\n        .removal(() => {\r\n            console.log('Script widget is destroyed');\r\n        });\r\n})\r\n"],"sourceRoot":"/source/"}