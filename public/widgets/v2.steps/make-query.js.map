{"version":3,"sources":["v2.steps/make-query.js"],"names":[],"mappings":"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","file":"v2.steps/make-query.js","sourcesContent":["import angular from 'angular';\r\nimport 'dictionary';\r\nimport 'custom-react-directives';\r\n\r\n\r\nvar m = angular.module(\"app.widgets.v2.steps.make-query\",['app','app.dictionary','custom-react-directives', 'app.dps']);\r\n\r\nm.factory(\"MakeQuery\",['$http', '$dps','$timeout', \"$lookup\", \"$translate\", '$q', \"dialog\", \"alert\",\r\n\r\n  function( $http, $dps, $timeout, $lookup, $translate, $q, dialog, alert){\r\n\r\n\treturn {\r\n\r\n    id : \"MakeQuery\",\r\n\t\t\r\n\t\ttitle : \"Query\",\r\n\r\n    description : \"Make Query\",\r\n        \r\n    html : \"./widgets/v2.steps/make-query.html\",\r\n\r\n    onStartWizard: function(wizard){\r\n      this.wizard = wizard;\r\n      this.conf = {}\r\n      // \r\n      // this.conf = {\r\n      //   query : wizard.conf.query,\r\n      //   dataset : wizard.conf.dataset\r\n      // }\r\n\r\n      // wizard.context.query = this.conf.query; \r\n      \r\n      // if (angular.isUndefined(this.conf.query)){\r\n      //     wizard.process(this);\r\n      // }else{\r\n      //     this.complete()\r\n      // }  \r\n    },\r\n\r\n    onFinishWizard : function(wizard){\r\n      // wizard.conf.query = this.conf.query;\r\n      // wizard.conf.dataset = this.conf.dataset;\r\n      // this.conf = {};\r\n    },\r\n\r\n    activate : function(wizard){\r\n        // this.query = wizard.conf.query;\r\n        this.conf.dataset = wizard.context.dataset;\r\n        if(angular.isUndefined(this.conf.query)){\r\n          wizard.process(this);\r\n        }else{\r\n          this.tryGetTable();\r\n          // this.complete();\r\n        }\r\n    },\r\n\r\n    complete : function(){\r\n      \r\n      this.wizard.context.dataset = this.conf.dataset;\r\n      this.wizard.context.query = this.conf.query;\r\n      if(!this.wizard.context.table && this.conf.query){\r\n        let thos = this;\r\n        $dps.post(\"/api/dataset/query\",this.conf.query)\r\n          .success( (resp) => {\r\n            thos.wizard.context.table = resp;\r\n            thos.wizard.complete(thos);            \r\n          })\r\n      }else{\r\n        this.wizard.complete(this);\r\n      }  \r\n    },\r\n\r\n    addQuery: function(){\r\n      \r\n      let defaultSettings = {\r\n        useColumnMetadata : [],  \r\n        useRowMetadata : [],\r\n        normalization : {\r\n          \"enable\" : false,\r\n          \"mode\" : \"Range to [0,1]\",\r\n          \"direction\" : \"Columns\"\r\n        },\r\n        reduce : {\r\n          \"enable\" : false,\r\n          \"mode\" : \"Has Null\",\r\n          \"direction\" : \"Columns\"\r\n        }\r\n      };\r\n\r\n\r\n      let q = this.wizard.parentScope.getQuery(this.conf.query);\r\n      \r\n      if(!q){\r\n        let thos = this;\r\n        dialog({\r\n            title:\"Enter Data Projection Title\",\r\n            fields:{\r\n              title:{\r\n                title:\"Title\",\r\n                value:\"\",\r\n                editable:true,\r\n                required:true\r\n              }\r\n            } \r\n        })\r\n        .then(function(form){\r\n          \r\n\r\n          $dps\r\n              .post(\"/api/data/process/\",\r\n                {\r\n                  \"cache\": false,\r\n                  \"data_query\": thos.conf.query,\r\n                  \"params\": defaultSettings,\r\n                  \"proc_name\": \"post-process\",\r\n                  \"response_type\": \"data\"\r\n                }    \r\n              )\r\n              .success(function (resp) {\r\n                  thos.conf.queryResultId = resp.data_id;\r\n                  thos.wizard.context.postprocessedTable = resp.data;\r\n                  thos.conf.dataset = undefined;\r\n                  thos.wizard.parentScope.addProjection(thos.conf,form.fields.title.value);\r\n                  // thos.wizard.context.queryResultId = resp.data_id;\r\n                  // thos.conf.queryResultId = resp.data_id;\r\n                  // thos.wizard.complete(thos);\r\n            })  \r\n           \r\n        })\r\n      }else{\r\n        alert.message([\"Doublicate of Projection\",(\"This projection exists with title: \"+q.$title)]);\r\n      }\r\n    },\r\n\r\n    lookup: $lookup,\r\n\r\n    setRole: function(dim, role){\r\n      dim.role = role;\r\n      this.wizard.process(this);\r\n      this.tryGetTable();   \r\n    },\r\n\r\n    genSelectionString: function(dim){\r\n      let buf = [];\r\n      // let s = \"\";\r\n      dim.selectionString = \"\";\r\n\r\n      dim.values.forEach(function(item){\r\n        if(item.selected){\r\n          buf.push(item)\r\n        }\r\n      })\r\n      if(buf.length === 0){\r\n        dim.selectionString = \"\";\r\n      }\r\n\r\n      for(let i in buf){\r\n        let k = ($lookup(buf[i].label).label)?$lookup(buf[i].label).label:buf[i].label;\r\n        $translate(k).then(function(translation){\r\n          dim.selectionString+=translation+\", \";\r\n          if(dim.selectionString.length >=45){\r\n            dim.selectionString = dim.selectionString.substring(0,40)+\"... (\"+buf.length+\" items) \"\r\n          }\r\n        })\r\n      }\r\n    },\r\n\r\n  select: function(dim,item){\r\n    this.wizard.process(this);\r\n    item.selected = item.selected || false;\r\n    item.selected = !item.selected;\r\n    this.genSelectionString(dim);\r\n    this.tryGetTable();\r\n  },\r\n\r\n  selectAll: function(dim){\r\n    this.wizard.process(this);\r\n    dim.values.forEach(function(item){\r\n      item.selected = true;\r\n    })\r\n    this.genSelectionString(dim);\r\n    this.tryGetTable();\r\n  },\r\n\r\n  clear: function(dim){\r\n    this.wizard.process(this);\r\n    dim.values.forEach(function(item){\r\n      item.selected = false;\r\n    })\r\n    this.genSelectionString(dim);\r\n    this.tryGetTable();\r\n  },\r\n  \r\n  reverse: function(dim){\r\n    this.wizard.process(this);\r\n    dim.values.forEach(function(item){\r\n      item.selected = !item.selected;\r\n    })\r\n    this.genSelectionString(dim);\r\n    this.tryGetTable();\r\n  },\r\n\r\n  getItemStyle: function(obj){\r\n    if(obj.selected){\r\n      return {\r\n        \"color\":\"#FFFFFF\",\r\n        \"background-color\":\"#008CBA\"\r\n      }\r\n    }  \r\n    return {\r\n        \"color\":\"#008CBA\",\r\n        \"background-color\":\"#FFFFFF\"\r\n      }\r\n  },\r\n\r\n  tryGetTable: function(){\r\n    this.requestComplete = this.testQuery(this.conf.dataset); \r\n    if(this.requestComplete){\r\n     this.request = this.makeRequest(this.conf.dataset);\r\n     this.conf.query = this.request;\r\n    if(this.canceler){\r\n      this.canceler.resolve();\r\n    }else{\r\n      // this.wizard.process(this);\r\n    }\r\n                                                  \r\n    this.canceler = $q.defer();\r\n    let thos = this; \r\n     if(this.wizard.context.table){\r\n        $dps.get(\"/api/table/delete/\"+this.wizard.context.table.id)\r\n          .success(function(){\r\n            thos.wizard.context.table = undefined; \r\n            // item.tableID = undefined;\r\n            \r\n            $dps.post(\"/api/dataset/query\",thos.request,{timeout:thos.canceler.promise})\r\n              .success(function(resp){\r\n              thos.wizard.context.table = resp;\r\n              thos.complete();\r\n              // item.tableID = resp.id;\r\n              // $scope.canceler.resolve();\r\n              // $scope.canceler = undefined;\r\n            })\r\n          }) \r\n     }else{\r\n        this.wizard.context.table = undefined;\r\n        // item.tableID = undefined;\r\n        $dps.post(\"/api/dataset/query\",this.request,{timeout:this.canceler.promise})\r\n          .success(function(resp){\r\n          thos.wizard.context.table = resp;\r\n          thos.complete();\r\n          // item.tableID = resp.id;\r\n        })\r\n     }\r\n     \r\n    }else{\r\n      let thos = this;  \r\n      if(this.wizard.context.table){\r\n        $dps.get(\"/api/table/delete/\"+this.wizard.context.table.id)\r\n          .success(function(){\r\n            thos.wizard.context.table = undefined;\r\n            // item.tableID = undefined;\r\n        });\r\n      }      \r\n    }\r\n  },\r\n\r\n  makeRequest: function(item){\r\n    let req = {};\r\n    req.commitID = item.dataset.commit.id;\r\n    req.datasetID = item.dataset.id;\r\n    \r\n    req.query = [];\r\n    req.locale = $translate.use();\r\n    for(let i in item.dimension){\r\n      let d = item.dimension[i];\r\n      let collection = this.getSelectedItems(d);\r\n      if (collection.length == d.values.length){\r\n        collection = [];\r\n      }else{\r\n        collection = collection.map(function(item){\r\n          return item.id;\r\n        })\r\n      }\r\n      req.query.push(\r\n          {\r\n            \"dimension\" : i,\r\n            \"role\" : d.role,\r\n            \"collection\" : collection \r\n          }\r\n      )\r\n    }\r\n    return req   \r\n  },\r\n\r\n  getSelectedItems: function(d){\r\n        let buf = [];\r\n        d.values.forEach(function(item){\r\n          if(item.selected){\r\n            buf.push(item)\r\n          }\r\n        })\r\n        return buf;\r\n  },\r\n\r\n  testQuery: function(item){\r\n      let columnsAvailable = false;\r\n      let rowsAvailable = false;\r\n      let splitColumnsAvailable = true;\r\n      let splitRowsAvailable = true;\r\n      for(let i in item.dimension){\r\n        let d = item.dimension[i];\r\n        if(d.role == \"Columns\" && this.getSelectedItems(d).length>0) columnsAvailable = true;\r\n        if(d.role == \"Rows\" && this.getSelectedItems(d).length>0) rowsAvailable = true;\r\n        if(d.role == \"Split Columns\"){\r\n          if(this.getSelectedItems(d).length>0){\r\n            splitColumnsAvailable &= true;\r\n          }else{\r\n            splitColumnsAvailable &= false;\r\n          }\r\n        }  \r\n        if(d.role == \"Split Rows\"){\r\n          if (this.getSelectedItems(d).length>0){ \r\n            splitRowsAvailable &= true;\r\n          }else{\r\n            splitRowsAvailable &= false;\r\n          }\r\n        }\r\n      }\r\n      return columnsAvailable && rowsAvailable && splitColumnsAvailable && splitRowsAvailable;\r\n    }\r\n \r\n\r\n\r\n\t\r\n  }\r\n}]);\t"],"sourceRoot":"/source/"}